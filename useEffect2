const closeInlineAI = useCallback(() => {
  setShowPrompt(false);
  setOutputs([]);
  setAnchorEl(undefined);
  setSelectedText('');
  (window as any).__kendoAnchorForInlineAI = undefined;
}, []);

useEffect(() => {
  if (!ShowPrompt) return; // only attach when AI is open

  const closeOnAnyEvent = (event: Event) => {
    const target = event.target as HTMLElement | null;
    if (!target) return;

    // ❌ DO NOT close if interacting INSIDE Inline AI itself
    if (
      target.closest('.k-inline-ai') ||
      target.closest('.k-inline-ai-prompt') ||
      target.closest('.k-popup')
    ) {
      return;
    }

    // ✅ Any other interaction → close AI
    closeInlineAI();
  };

  // Capture phase so we beat focus/selection changes
  document.addEventListener('mousedown', closeOnAnyEvent, true);
  document.addEventListener('keydown', closeOnAnyEvent, true);
  document.addEventListener('wheel', closeOnAnyEvent, true);
  document.addEventListener('touchstart', closeOnAnyEvent, true);

  return () => {
    document.removeEventListener('mousedown', closeOnAnyEvent, true);
    document.removeEventListener('keydown', closeOnAnyEvent, true);
    document.removeEventListener('wheel', closeOnAnyEvent, true);
    document.removeEventListener('touchstart', closeOnAnyEvent, true);
  };
}, [ShowPrompt, closeInlineAI]);
