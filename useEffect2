React.useEffect(() => {
  const onDocMouseDown = (ev: MouseEvent) => {
    try {
      const path = (ev as any).composedPath?.() || (ev as any).path || [];
      let inside = false;

      // Detect click inside AI prompt
      for (const p of path) {
        if (
          p &&
          p.classList &&
          (
            p.classList.contains('k-inlineai') ||
            p.classList.contains('k-inline-ai-prompt') ||
            p.classList.contains('k-inline-ai')
          )
        ) {
          inside = true;
          break;
        }
      }

      // Detect click inside editor or editor UI
      if (!inside) {
        const target = ev.target as HTMLElement | null;
        if (
          target &&
          target.closest &&
          (
            target.closest('.k-inlineai, .k-inline-ai-prompt, .k-inline-ai') ||
            target.closest('.k-editor') ||
            target.closest('.k-editor-content') ||
            target.closest('.ProseMirror') ||
            target.closest('.k-editor-toolbar')
          )
        ) {
          inside = true;
        }
      }

      clickedInsidePromptRef.current = inside;
    } catch {
      clickedInsidePromptRef.current = false;
    }
  };

  document.addEventListener('mousedown', onDocMouseDown, true);
  return () => document.removeEventListener('mousedown', onDocMouseDown, true);
}, []);
