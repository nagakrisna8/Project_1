 React.useEffect(() => {
  const fixPosition = () => {
    const prompt = document.querySelector('.k-ai-inline-prompt') as HTMLElement;
    const menu = document.querySelector('.k-ai-command-menu') as HTMLElement;
    const wrapper = editorWrapperRef.current;

    if (!prompt || !menu || !wrapper) return;

    const promptRect = prompt.getBoundingClientRect();
    const wrapperRect = wrapper.getBoundingClientRect();

    const menuHeight = menu.offsetHeight;
    const scrollTop = wrapper.scrollTop;

    // calculate position INSIDE editor
    const topRelativeToEditor =
      promptRect.top - wrapperRect.top + scrollTop;

    const spaceBelow =
      wrapper.scrollHeight -
      (topRelativeToEditor + prompt.offsetHeight);

    menu.style.position = 'absolute';
    menu.style.left = `${promptRect.left - wrapperRect.left}px`;

    if (spaceBelow < menuHeight + 8) {
      // ABOVE
      menu.style.top = `${topRelativeToEditor - menuHeight - 8}px`;
    } else {
      // BELOW
      menu.style.top = `${topRelativeToEditor + prompt.offsetHeight + 8}px`;
    }
  };

  const observer = new MutationObserver(fixPosition);
  observer.observe(document.body, { childList: true, subtree: true });

  editorWrapperRef.current?.addEventListener('scroll', fixPosition);
  window.addEventListener('resize', fixPosition);

  return () => {
    observer.disconnect();
    editorWrapperRef.current?.removeEventListener('scroll', fixPosition);
    window.removeEventListener('resize', fixPosition);
  };
}, []);
