const gridChildren = React.useMemo(() => {
  const allChildren = React.Children.toArray(GridProps.children);

  const toolBar = allChildren.find(
    (c: any) => c?.type?.displayName === "KendoReactGridToolbar"
  );

  const gridToolBar = (
    <GridToolbar key="grid-toolbar" {...toolBar?.props}>
      {/* your existing toolbar content */}
      {toolBar && toolBar.props.children && <div>{toolBar.props.children}</div>}
    </GridToolbar>
  );

  let children: any[] = [];

  allChildren.forEach((child: any, index) => {
    if (!child || child === ",") return;

    // ✅ Skip toolbar here (we add it later)
    if (child?.type?.displayName === "KendoReactGridToolbar") return;

    // ✅ Checkbox column is a normal GridColumn → always include
    if (child?.type?.displayName === "KendoReactGridColumn") {
      children.push(<Column {...child.props} key={`col-${index}`} />);
      return;
    }

    // ✅ Dynamic columns are inside ARRAY → apply hide/show here
    if (Array.isArray(child)) {
      child.forEach((colChild: any, colIndex: number) => {
        if (colChild?.type?.displayName === "KendoReactGridColumn") {
          const key = colChild.props.title ?? colChild.props.field;

          // ✅ Hide/Show check
          if (columnsState[key]) {
            children.push(
              <Column {...colChild.props} key={`dyn-${colIndex}`} />
            );
          }
        }
      });
      return;
    }

    // ✅ Any other element
    children.push(child);
  });

  // ✅ Add toolbar at end
  if (props.toolbarSettings) {
    children.push(gridToolBar);
  } else if (toolBar) {
    children.push(toolBar);
  }

  return children;
}, [GridProps.children, columnsState, filterValue, collapsedState, configuration]);
